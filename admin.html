<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin ‚Äî Mantenimiento ITC</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --verde: #1a7a3c;
    --verde-oscuro: #145e2e;
    --verde-claro: #e8f5ee;
    --gris: #f2f5f2;
    --borde: #c8dece;
    --texto: #1a2e1f;
    --sub: #5a6b5e;
    --error: #c0392b;
    --amarillo: #f39c12;
    --azul: #2980b9;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Open Sans', sans-serif; background: var(--gris); min-height: 100vh; }

  /* ===== LOGIN ===== */
  .login-screen {
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    padding: 20px; background: linear-gradient(135deg, var(--verde-oscuro), #1e8f46);
  }
  .login-card {
    background: white; border-radius: 20px; padding: 40px 32px;
    width: 100%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;
  }
  .login-logo {
    width: 70px; height: 70px; background: var(--verde-oscuro); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 20px;
    color: white; margin: 0 auto 20px;
  }
  .login-card h1 { font-family: 'Montserrat', sans-serif; font-size: 20px; font-weight: 800; color: var(--verde-oscuro); margin-bottom: 6px; }
  .login-card p { font-size: 13px; color: var(--sub); margin-bottom: 28px; }
  .login-card input {
    width: 100%; padding: 13px 16px; border: 1.5px solid var(--borde);
    border-radius: 10px; font-size: 14px; font-family: 'Open Sans', sans-serif;
    color: var(--texto); margin-bottom: 12px; -webkit-appearance: none;
  }
  .login-card input:focus { outline: none; border-color: var(--verde); }
  .btn-login {
    width: 100%; padding: 14px; border: none; border-radius: 12px;
    background: linear-gradient(135deg, var(--verde-oscuro), #1e8f46);
    color: white; font-size: 15px; font-weight: 700;
    font-family: 'Montserrat', sans-serif; cursor: pointer;
  }
  .login-error { color: var(--error); font-size: 13px; margin-top: 10px; display: none; }

  /* ===== HEADER ===== */
  .header {
    background: var(--verde-oscuro); padding: 14px 20px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .logo {
    width: 38px; height: 38px; background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 11px;
    color: var(--verde-oscuro); flex-shrink: 0;
  }
  .header h1 { color: white; font-family: 'Montserrat', sans-serif; font-size: 14px; font-weight: 700; }
  .header p { color: rgba(255,255,255,0.7); font-size: 11px; }
  .btn-salir {
    background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
    color: white; padding: 7px 14px; border-radius: 8px; font-size: 12px;
    font-family: 'Montserrat', sans-serif; font-weight: 600; cursor: pointer;
  }

  /* ===== TABS ===== */
  .tabs-bar {
    background: white; border-bottom: 2px solid var(--borde);
    display: flex; padding: 0 16px; gap: 4px; position: sticky; top: 67px; z-index: 99;
  }
  .tab-btn {
    padding: 14px 20px; border: none; background: none; cursor: pointer;
    font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600;
    color: var(--sub); border-bottom: 3px solid transparent; margin-bottom: -2px;
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .tab-btn:hover { color: var(--verde); }
  .tab-btn.active { color: var(--verde-oscuro); border-bottom-color: var(--verde-oscuro); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ===== SOLICITUDES ===== */
  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    padding: 16px; max-width: 1100px; margin: 0 auto;
  }
  .stat-card {
    background: white; border-radius: 12px; padding: 14px; text-align: center;
    border-left: 4px solid var(--borde); box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  }
  .stat-card.pendiente { border-left-color: var(--amarillo); }
  .stat-card.proceso { border-left-color: var(--azul); }
  .stat-card.completado { border-left-color: var(--verde); }
  .stat-card.total { border-left-color: var(--verde-oscuro); }
  .stat-num { font-family: 'Montserrat', sans-serif; font-size: 28px; font-weight: 800; color: var(--texto); }
  .stat-label { font-size: 11px; color: var(--sub); margin-top: 2px; font-weight: 600; }

  .filtros {
    padding: 0 16px 14px; max-width: 1100px; margin: 0 auto;
    display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
  }
  .filtros select {
    padding: 9px 12px; border: 1.5px solid var(--borde); border-radius: 9px;
    font-size: 13px; font-family: 'Open Sans', sans-serif; color: var(--texto);
    background: white; -webkit-appearance: none; cursor: pointer;
  }
  .filtros select:focus { outline: none; border-color: var(--verde); }
  .btn-actualizar {
    padding: 9px 16px; background: var(--verde); border: none; border-radius: 9px;
    color: white; font-size: 13px; font-weight: 700; font-family: 'Montserrat', sans-serif; cursor: pointer;
  }

  .tabla-wrap { padding: 0 16px; max-width: 1100px; margin: 0 auto; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
  thead { background: var(--verde-oscuro); }
  th { padding: 12px 14px; text-align: left; color: white; font-size: 12px; font-family: 'Montserrat', sans-serif; font-weight: 600; white-space: nowrap; }
  td { padding: 12px 14px; font-size: 13px; color: var(--texto); border-bottom: 1px solid #f0f4f0; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f8fbf8; cursor: pointer; }

  .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; font-family: 'Montserrat', sans-serif; }
  .badge-pendiente, .badge-Pendiente { background: #fef3cd; color: #856404; }
  .badge-proceso { background: #cce5ff; color: #004085; }
  .badge-En\ proceso { background: #cce5ff; color: #004085; }
  .badge-completado, .badge-Completado { background: var(--verde-claro); color: var(--verde-oscuro); }
  .badge-cancelado, .badge-Cancelado { background: #f8d7da; color: #721c24; }
  .folio-text { font-family: 'Montserrat', sans-serif; font-size: 11px; font-weight: 700; color: var(--verde-oscuro); }

  /* ===== MODAL ===== */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    z-index: 200; display: none; align-items: flex-start; justify-content: center;
    padding: 20px; overflow-y: auto;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: white; border-radius: 16px; width: 100%; max-width: 600px;
    margin: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header {
    background: var(--verde-oscuro); padding: 18px 20px; border-radius: 16px 16px 0 0;
    display: flex; justify-content: space-between; align-items: center;
  }
  .modal-header h2 { color: white; font-family: 'Montserrat', sans-serif; font-size: 15px; font-weight: 700; }
  .btn-cerrar {
    background: rgba(255,255,255,0.2); border: none; color: white;
    width: 30px; height: 30px; border-radius: 50%; font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .modal-body { padding: 20px; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .info-item { background: var(--gris); border-radius: 10px; padding: 12px; }
  .info-item label { font-size: 10px; font-weight: 700; font-family: 'Montserrat', sans-serif; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px; }
  .info-item span { font-size: 13px; color: var(--texto); font-weight: 600; }
  .info-item.full { grid-column: 1 / -1; }
  .section-title {
    font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 700;
    color: var(--verde-oscuro); text-transform: uppercase; letter-spacing: 0.5px;
    margin: 18px 0 10px; padding-bottom: 6px; border-bottom: 2px solid var(--verde-claro);
  }
  .personal-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
  .personal-chip {
    padding: 8px 14px; border: 2px solid var(--borde); border-radius: 20px;
    font-size: 12px; font-weight: 600; color: var(--sub);
    font-family: 'Montserrat', sans-serif; cursor: pointer; transition: all 0.2s; background: white;
  }
  .personal-chip:hover { border-color: var(--verde); color: var(--verde); }
  .personal-chip.selected { border-color: var(--verde); background: var(--verde-claro); color: var(--verde-oscuro); }
  .modal-field { margin-bottom: 14px; }
  .modal-field label { display: block; font-size: 12px; font-weight: 700; font-family: 'Montserrat', sans-serif; color: var(--texto); margin-bottom: 6px; }
  .modal-field input, .modal-field select, .modal-field textarea {
    width: 100%; padding: 11px 13px; border: 1.5px solid var(--borde);
    border-radius: 9px; font-size: 13px; font-family: 'Open Sans', sans-serif;
    color: var(--texto); background: white; -webkit-appearance: none;
  }
  .modal-field input:focus, .modal-field select:focus, .modal-field textarea:focus { outline: none; border-color: var(--verde); }
  .modal-field textarea { height: 70px; resize: none; }
  .modal-field .dos-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .modal-footer {
    padding: 16px 20px; border-top: 1px solid var(--borde);
    display: flex; gap: 10px; justify-content: flex-end;
  }
  .btn-cancelar-modal {
    padding: 11px 20px; border: 2px solid var(--borde); border-radius: 10px;
    background: white; color: var(--sub); font-size: 13px; font-weight: 700;
    font-family: 'Montserrat', sans-serif; cursor: pointer;
  }
  .btn-guardar {
    padding: 11px 24px; border: none; border-radius: 10px;
    background: linear-gradient(135deg, var(--verde-oscuro), #1e8f46);
    color: white; font-size: 13px; font-weight: 700;
    font-family: 'Montserrat', sans-serif; cursor: pointer;
  }

  /* ===== DASHBOARD ===== */
  .dash-container { max-width: 1200px; margin: 0 auto; padding: 20px 16px; }
  .periodo-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
  .periodo-btn {
    padding: 8px 16px; border: 2px solid var(--borde); border-radius: 20px;
    background: white; font-size: 12px; font-weight: 600;
    font-family: 'Montserrat', sans-serif; color: var(--sub); cursor: pointer; transition: all 0.2s;
  }
  .periodo-btn.active { border-color: var(--verde); background: var(--verde-claro); color: var(--verde-oscuro); }
  .stats-grid-dash {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px;
  }
  .stat-card-dash {
    background: white; border-radius: 14px; padding: 18px 16px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.07); border-top: 4px solid var(--borde);
  }
  .stat-card-dash.total { border-top-color: var(--verde-oscuro); }
  .stat-card-dash.pendiente { border-top-color: var(--amarillo); }
  .stat-card-dash.proceso { border-top-color: var(--azul); }
  .stat-card-dash.completado { border-top-color: var(--verde); }
  .stat-icon { font-size: 22px; margin-bottom: 6px; }
  .stat-big { font-family: 'Montserrat', sans-serif; font-size: 34px; font-weight: 800; color: var(--texto); }
  .stat-lbl { font-size: 12px; color: var(--sub); margin-top: 2px; font-weight: 600; }
  .costo-card {
    background: linear-gradient(135deg, var(--verde-oscuro), #1e8f46);
    border-radius: 14px; padding: 20px; color: white; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
  }
  .costo-item { text-align: center; }
  .costo-num { font-family: 'Montserrat', sans-serif; font-size: 26px; font-weight: 800; }
  .costo-lbl { font-size: 11px; opacity: 0.8; margin-top: 2px; }
  .charts-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;
  }
  .chart-card { background: white; border-radius: 14px; padding: 20px; box-shadow: 0 1px 8px rgba(0,0,0,0.07); }
  .chart-card.full { grid-column: 1 / -1; }
  .chart-title { font-family: 'Montserrat', sans-serif; font-size: 14px; font-weight: 700; color: var(--texto); margin-bottom: 4px; }
  .chart-sub { font-size: 11px; color: var(--sub); margin-bottom: 16px; }
  .chart-wrap { position: relative; height: 240px; }
  .chart-wrap.tall { height: 300px; }
  .detalle-panel {
    background: white; border-radius: 14px; padding: 20px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.07); margin-bottom: 20px;
    display: none; animation: fadeIn 0.3s ease;
  }
  .detalle-panel.show { display: block; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
  .detalle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .detalle-title { font-family: 'Montserrat', sans-serif; font-size: 15px; font-weight: 700; color: var(--verde-oscuro); }
  .btn-cerrar-detalle {
    background: var(--gris); border: none; border-radius: 8px; padding: 6px 12px;
    font-size: 12px; cursor: pointer; color: var(--sub); font-weight: 600;
  }
  .detalle-tabla { width: 100%; border-collapse: collapse; font-size: 13px; }
  .detalle-tabla th { padding: 10px 12px; text-align: left; background: var(--verde-oscuro); color: white; font-family: 'Montserrat', sans-serif; font-size: 11px; font-weight: 600; }
  .detalle-tabla td { padding: 10px 12px; border-bottom: 1px solid #f0f4f0; }
  .detalle-tabla tr:hover td { background: var(--verde-claro); }
  .personal-grid-dash { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .personal-card { background: var(--gris); border-radius: 10px; padding: 12px; border-left: 3px solid var(--verde); }
  .personal-count { font-size: 22px; font-weight: 800; color: var(--verde-oscuro); font-family: 'Montserrat', sans-serif; }
  .personal-nombre { font-size: 12px; font-weight: 700; color: var(--texto); font-family: 'Montserrat', sans-serif; }
  .personal-label { font-size: 11px; color: var(--sub); }

  /* ===== TOAST ===== */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    color: white; padding: 12px 20px; border-radius: 10px; font-size: 13px;
    font-family: 'Montserrat', sans-serif; font-weight: 600; z-index: 9999;
    opacity: 0; transition: opacity 0.3s; max-width: 88vw; text-align: center;
    pointer-events: none; background: var(--verde-oscuro);
  }

  /* ===== REPORTES DIARIOS ===== */
  .reportes-container { max-width: 900px; margin: 0 auto; padding: 20px 16px; }
  .dia-grupo { margin-bottom: 24px; }
  .dia-header {
    font-family: 'Montserrat', sans-serif; font-size: 14px; font-weight: 800;
    color: var(--texto); padding: 8px 0; margin-bottom: 10px;
    border-bottom: 2px solid var(--borde); display: flex; align-items: center; gap: 8px;
  }
  .reporte-card {
    background: white; border-radius: 12px; margin-bottom: 10px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.07); overflow: hidden;
    display: flex; cursor: pointer; transition: box-shadow 0.2s;
    border-left: 5px solid var(--borde);
  }
  .reporte-card:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.12); }
  .reporte-card.completado { border-left-color: var(--verde); }
  .reporte-card.en-proceso { border-left-color: var(--azul); }
  .reporte-card.pendiente { border-left-color: var(--amarillo); }
  .reporte-card.urgente { border-left-color: var(--error); animation: pulso 2s infinite; }
  @keyframes pulso { 0%,100%{border-left-color:var(--error)} 50%{border-left-color:#ff6b6b} }
  .reporte-thumb {
    width: 70px; height: 70px; object-fit: cover; flex-shrink: 0;
    background: var(--gris);
  }
  .reporte-thumb-placeholder {
    width: 70px; height: 70px; background: var(--gris); flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; font-size: 24px;
  }
  .reporte-info { padding: 10px 14px; flex: 1; }
  .reporte-fecha { font-size: 11px; font-weight: 700; font-family: 'Montserrat', sans-serif; color: var(--sub); }
  .reporte-area { font-size: 13px; font-weight: 600; color: var(--texto); margin: 2px 0; }
  .reporte-ubicacion { font-size: 12px; color: var(--sub); }
  .reporte-estatus-col { padding: 10px 14px; display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 6px; flex-shrink: 0; }
  .icono-estatus { font-size: 20px; }

  /* MODAL REPORTE */
  .modal-reporte { max-width: 700px; }
  .fotos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
  .foto-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
  .foto-item img { width: 100%; height: 100%; object-fit: cover; }
  .foto-remove {
    position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6);
    color: white; border: none; border-radius: 50%; width: 22px; height: 22px;
    font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .foto-add {
    border: 2px dashed var(--borde); border-radius: 8px; aspect-ratio: 1;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; background: var(--gris); font-size: 24px; color: var(--sub);
    transition: all 0.2s;
  }
  .foto-add:hover { border-color: var(--verde); background: var(--verde-claro); }
  .avances-lista { margin-bottom: 16px; }
  .avance-item {
    background: var(--gris); border-radius: 10px; padding: 12px 14px;
    margin-bottom: 8px; border-left: 3px solid var(--azul);
  }
  .avance-fecha { font-size: 11px; font-weight: 700; color: var(--sub); font-family: 'Montserrat', sans-serif; }
  .avance-texto { font-size: 13px; color: var(--texto); margin-top: 4px; }
  .avance-fotos { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
  .avance-foto-thumb { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; cursor: pointer; }

  /* ===== BARRA DE PROGRESO ===== */
  .progress-bar {
    display: flex; align-items: center; gap: 0; width: 100%;
  }
  .progress-step {
    display: flex; align-items: center; gap: 4px; font-size: 10px;
    font-family: 'Montserrat', sans-serif; font-weight: 600; color: #aaa; flex: 1;
  }
  .progress-step:last-child { flex: 0; }
  .progress-dot {
    width: 12px; height: 12px; border-radius: 50%; background: #ddd;
    flex-shrink: 0; border: 2px solid #ddd; transition: all 0.3s;
  }
  .progress-line {
    flex: 1; height: 3px; background: #ddd; transition: all 0.3s;
  }
  .progress-step.done .progress-dot { background: var(--verde); border-color: var(--verde); }
  .progress-step.done .progress-line { background: var(--verde); }
  .progress-step.done { color: var(--verde-oscuro); }
  .progress-step.active .progress-dot { background: white; border-color: var(--verde); box-shadow: 0 0 0 3px rgba(26,122,60,0.2); }
  .progress-step.active { color: var(--verde-oscuro); }
  .progress-step.cancelado .progress-dot { background: var(--error); border-color: var(--error); }

  /* Barra mini en tabla */
  .mini-progress { display: flex; gap: 3px; align-items: center; }
  .mini-dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; }
  .mini-dot.done { background: var(--verde); }
  .mini-dot.active { background: var(--amarillo); }
  .mini-dot.cancelado { background: var(--error); }

  @media (max-width: 700px) {
    .stats-row, .stats-grid-dash { grid-template-columns: 1fr 1fr; }
    .charts-grid { grid-template-columns: 1fr; }
    .chart-card.full { grid-column: 1; }
    .personal-grid-dash { grid-template-columns: 1fr 1fr; }
    .info-grid { grid-template-columns: 1fr; }
    .modal-field .dos-col { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div class="login-screen" id="login-screen">
  <div class="login-card">
    <div class="login-logo">ITC</div>
    <h1>Panel de Administrador</h1>
    <p>Departamento de Mantenimiento de Equipo</p>
    <input type="text" id="login-user" placeholder="Usuario" autocomplete="username">
    <input type="password" id="login-pass" placeholder="Contrase√±a" autocomplete="current-password"
      onkeydown="if(event.key==='Enter') iniciarSesion()">
    <button class="btn-login" onclick="iniciarSesion()">Entrar ‚Üí</button>
    <div class="login-error" id="login-error">Usuario o contrase√±a incorrectos.</div>
  </div>
</div>

<!-- ===== PANEL PRINCIPAL ===== -->
<div id="panel-principal" style="display:none">

  <div class="header">
    <div class="header-left">
      <div class="logo">ITC</div>
      <div>
        <h1>Mantenimiento de Equipo</h1>
        <p>Instituto Tecnol√≥gico de Celaya</p>
      </div>
    </div>
    <button class="btn-salir" onclick="cerrarSesion()">Salir</button>
  </div>

  <!-- TABS -->
  <div class="tabs-bar">
    <button class="tab-btn active" onclick="cambiarTab('solicitudes', this)">üìã Solicitudes</button>
    <button class="tab-btn" onclick="cambiarTab('dashboard', this)">üìä Dashboard</button>
    <button class="tab-btn" onclick="cambiarTab('reportes', this)">üìù Reportes</button>
    <button class="tab-btn" onclick="cambiarTab('dash-reportes', this)">üìà Stats Reportes</button>
  </div>

  <!-- ===== TAB: SOLICITUDES ===== -->
  <div class="tab-content active" id="tab-solicitudes">
    <div class="stats-row">
      <div class="stat-card total"><div class="stat-num" id="stat-total">‚Äî</div><div class="stat-label">Total</div></div>
      <div class="stat-card pendiente"><div class="stat-num" id="stat-pendiente">‚Äî</div><div class="stat-label">‚è≥ Pendientes</div></div>
      <div class="stat-card proceso"><div class="stat-num" id="stat-proceso">‚Äî</div><div class="stat-label">üîß En proceso</div></div>
      <div class="stat-card completado"><div class="stat-num" id="stat-completado">‚Äî</div><div class="stat-label">‚úÖ Completadas</div></div>
    </div>
    <div class="filtros">
      <select id="filtro-estatus" onchange="cargarSolicitudes()">
        <option value="">Todos los estatus</option>
        <option>Pendiente</option><option>En proceso</option>
        <option>Completado</option><option>Cancelado</option>
      </select>
      <select id="filtro-area" onchange="cargarSolicitudes()">
        <option value="">Todas las √°reas</option>
        <option>Aire Acondicionado</option><option>El√©ctrico</option>
        <option>Herrer√≠a</option><option>Infraestructura</option>
        <option>Pintura</option><option>Plomer√≠a</option>
        <option>Servicios Especializados</option><option>Servicios Generales</option><option>Otro</option>
      </select>
      <select id="filtro-campus" onchange="cargarSolicitudes()">
        <option value="">Todos los campus</option>
        <option>Campus I</option><option>Campus II</option>
        <option>Extensi√≥n Apaseo el Grande</option>
      </select>
      <button class="btn-actualizar" onclick="cargarSolicitudes()">üîÑ Actualizar</button>
    </div>
    <div class="tabla-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th><th>Folio</th><th>Fecha</th><th>√Årea</th><th>Campus</th>
            <th>Ubicaci√≥n</th><th>Descripci√≥n</th><th>Estatus</th><th>Personal</th>
          </tr>
        </thead>
        <tbody id="tabla-body">
          <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--sub)">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== TAB: DASHBOARD ===== -->
  <div class="tab-content" id="tab-dashboard">
    <div class="dash-container">

      <div class="periodo-bar">
        <span style="font-size:13px;color:var(--sub);font-weight:600;margin-right:4px">Per√≠odo:</span>
        <button class="periodo-btn" onclick="filtrarPeriodo(7,this)">7 d√≠as</button>
        <button class="periodo-btn active" onclick="filtrarPeriodo(30,this)">30 d√≠as</button>
        <button class="periodo-btn" onclick="filtrarPeriodo(90,this)">3 meses</button>
        <button class="periodo-btn" onclick="filtrarPeriodo(365,this)">1 a√±o</button>
        <button class="periodo-btn" onclick="filtrarPeriodo(9999,this)">Todo</button>
      </div>

      <div class="costo-card">
        <div class="costo-item"><div class="costo-num" id="d-costo-total">$0</div><div class="costo-lbl">üí∞ Costo total</div></div>
        <div class="costo-item"><div class="costo-num" id="d-costo-prom">$0</div><div class="costo-lbl">üìä Costo promedio</div></div>
        <div class="costo-item"><div class="costo-num" id="d-area-max">‚Äî</div><div class="costo-lbl">üèÜ √Årea mayor costo</div></div>
        <div class="costo-item"><div class="costo-num" id="d-tiempo-prom">‚Äî d√≠as</div><div class="costo-lbl">‚è±Ô∏è Tiempo promedio</div></div>
      </div>

      <div class="stats-grid-dash">
        <div class="stat-card-dash total"><div class="stat-icon">üìã</div><div class="stat-big" id="d-total">‚Äî</div><div class="stat-lbl">Total solicitudes</div></div>
        <div class="stat-card-dash pendiente"><div class="stat-icon">‚è≥</div><div class="stat-big" id="d-pendiente">‚Äî</div><div class="stat-lbl">Pendientes</div></div>
        <div class="stat-card-dash proceso"><div class="stat-icon">üîß</div><div class="stat-big" id="d-proceso">‚Äî</div><div class="stat-lbl">En proceso</div></div>
        <div class="stat-card-dash completado"><div class="stat-icon">‚úÖ</div><div class="stat-big" id="d-completado">‚Äî</div><div class="stat-lbl">Completadas</div></div>
      </div>

      <div class="detalle-panel" id="detalle-panel">
        <div class="detalle-header">
          <div class="detalle-title" id="detalle-titulo">Detalle</div>
          <button class="btn-cerrar-detalle" onclick="cerrarDetalle()">‚úï Cerrar</button>
        </div>
        <div style="overflow-x:auto">
          <table class="detalle-tabla">
            <thead><tr><th style="width:40px">#</th><th>Folio</th><th>Fecha</th><th>√Årea</th><th>Ubicaci√≥n</th><th>Descripci√≥n</th><th>Personal</th><th>Estatus</th><th>Costo</th></tr></thead>
            <tbody id="detalle-body"></tbody>
          </table>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">üìä Solicitudes por √Årea</div>
          <div class="chart-sub">Haz clic en una barra para ver el detalle</div>
          <div class="chart-wrap"><canvas id="chart-area"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üéØ Distribuci√≥n por Estatus</div>
          <div class="chart-sub">Estado actual de las solicitudes</div>
          <div class="chart-wrap"><canvas id="chart-estatus"></canvas></div>
        </div>
        <div class="chart-card full">
          <div class="chart-title">üìÖ Solicitudes por D√≠a</div>
          <div class="chart-sub">Haz clic en un punto para ver el detalle</div>
          <div class="chart-wrap tall"><canvas id="chart-tiempo"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üè´ Solicitudes por Campus</div>
          <div class="chart-sub">Haz clic para ver detalle</div>
          <div class="chart-wrap"><canvas id="chart-campus"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üí∞ Costo por √Årea</div>
          <div class="chart-sub">Total invertido en cada √°rea</div>
          <div class="chart-wrap"><canvas id="chart-costo"></canvas></div>
        </div>
        <div class="chart-card full">
          <div class="chart-title">üè´ Gasto por Campus</div>
          <div class="chart-sub">Total invertido en cada campus ‚Äî haz clic para ver detalle</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center">
            <div class="chart-wrap" style="height:220px"><canvas id="chart-gasto-campus"></canvas></div>
            <div id="campus-gasto-detalle" style="display:flex;flex-direction:column;gap:10px"></div>
          </div>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom:20px">
        <div class="chart-title">üë∑ Personal m√°s activo</div>
        <div class="chart-sub">Trabajos asignados por persona</div>
        <div class="personal-grid-dash" id="personal-dash"></div>
      </div>

    </div>
  </div>

</div>

  <!-- ===== TAB: REPORTES ===== -->
  <div class="tab-content" id="tab-reportes">
    <div class="reportes-container">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div>
          <h2 style="font-family:Montserrat,sans-serif;font-size:18px;font-weight:800;color:var(--texto)">Reportes de Actividad</h2>
          <p style="font-size:12px;color:var(--sub);margin-top:2px">Agrupados por d√≠a ‚Äî m√°s recientes primero</p>
        </div>
        <button onclick="abrirReporteLibre()" style="background:linear-gradient(135deg,#145e2e,#1e8f46);color:white;border:none;border-radius:10px;padding:10px 18px;font-family:Montserrat,sans-serif;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px">
          ‚ûï Nuevo reporte libre
        </button>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="display:flex;gap:6px;font-size:11px;align-items:center">
            <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--verde);border-radius:50%;display:inline-block"></span>Completado</span>
            <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--azul);border-radius:50%;display:inline-block"></span>En proceso</span>
            <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--amarillo);border-radius:50%;display:inline-block"></span>Pendiente</span>
            <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--error);border-radius:50%;display:inline-block"></span>+4 d√≠as sin atender</span>
          </div>
        </div>
      </div>
      <div id="reportes-lista">
        <div style="text-align:center;padding:60px;color:var(--sub)">Cargando reportes...</div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: DASHBOARD REPORTES ===== -->
  <div class="tab-content" id="tab-dash-reportes">
    <div class="dash-container">

      <div class="periodo-bar">
        <span style="font-size:13px;color:var(--sub);font-weight:600;margin-right:4px">Per√≠odo:</span>
        <button class="periodo-btn" onclick="filtrarPeriodoRep(7,this)">7 d√≠as</button>
        <button class="periodo-btn active" onclick="filtrarPeriodoRep(30,this)">30 d√≠as</button>
        <button class="periodo-btn" onclick="filtrarPeriodoRep(90,this)">3 meses</button>
        <button class="periodo-btn" onclick="filtrarPeriodoRep(365,this)">1 a√±o</button>
        <button class="periodo-btn" onclick="filtrarPeriodoRep(9999,this)">Todo</button>
      </div>

      <!-- STATS REPORTES -->
      <div class="stats-grid-dash" style="margin-bottom:20px">
        <div class="stat-card-dash total"><div class="stat-icon">üìã</div><div class="stat-big" id="dr-total">‚Äî</div><div class="stat-lbl">Total reportes</div></div>
        <div class="stat-card-dash completado"><div class="stat-icon">‚úÖ</div><div class="stat-big" id="dr-completado">‚Äî</div><div class="stat-lbl">Completados</div></div>
        <div class="stat-card-dash proceso"><div class="stat-icon">üîß</div><div class="stat-big" id="dr-proceso">‚Äî</div><div class="stat-lbl">En proceso</div></div>
        <div class="stat-card-dash pendiente"><div class="stat-icon">‚è∏Ô∏è</div><div class="stat-big" id="dr-detenido">‚Äî</div><div class="stat-lbl">Detenidos</div></div>
      </div>

      <!-- DETALLE AL CLICK -->
      <div class="detalle-panel" id="detalle-rep-panel">
        <div class="detalle-header">
          <div class="detalle-title" id="detalle-rep-titulo">Detalle</div>
          <button class="btn-cerrar-detalle" onclick="cerrarDetalleRep()">‚úï Cerrar</button>
        </div>
        <div style="overflow-x:auto">
          <table class="detalle-tabla">
            <thead><tr><th style="width:40px">#</th><th>Folio</th><th>Fecha</th><th>√Årea</th><th>Ubicaci√≥n</th><th>Objetivo</th><th>Personal</th><th>Estatus</th></tr></thead>
            <tbody id="detalle-rep-body"></tbody>
          </table>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">üìä Reportes por √Årea</div>
          <div class="chart-sub">Haz clic para ver detalle</div>
          <div class="chart-wrap"><canvas id="rc-area"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üéØ Reportes por Estatus</div>
          <div class="chart-sub">Estado de los trabajos</div>
          <div class="chart-wrap"><canvas id="rc-estatus"></canvas></div>
        </div>
        <div class="chart-card full">
          <div class="chart-title">üìÖ Reportes por D√≠a</div>
          <div class="chart-sub">Actividad del equipo en el tiempo</div>
          <div class="chart-wrap tall"><canvas id="rc-tiempo"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üè´ Reportes por Campus</div>
          <div class="chart-sub">Distribuci√≥n por campus</div>
          <div class="chart-wrap"><canvas id="rc-campus"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üîñ Tipo de Reporte</div>
          <div class="chart-sub">Libre (DME/L) vs Solicitud (DME/)</div>
          <div class="chart-wrap"><canvas id="rc-tipo"></canvas></div>
        </div>
      </div>

      <!-- PERSONAL M√ÅS ACTIVO EN REPORTES -->
      <div class="chart-card" style="margin-bottom:20px">
        <div class="chart-title">üë∑ Personal m√°s activo en reportes</div>
        <div class="chart-sub">Trabajos realizados por persona</div>
        <div class="personal-grid-dash" id="personal-rep-dash"></div>
      </div>

    </div>
  </div>

<!-- ===== MODAL REPORTE DIARIO ===== -->
<div class="modal-overlay" id="modal-reporte-overlay" onclick="cerrarModalReporteOverlay(event)">
  <div class="modal modal-reporte">
    <div class="modal-header">
      <div>
        <h2 id="mr-folio">Reporte de Trabajo</h2>
        <div id="mr-solicitud-info" style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:2px"></div>
      </div>
      <button class="btn-cerrar" onclick="cerrarModalReporte()">‚úï</button>
    </div>
    <div class="modal-body" style="max-height:75vh;overflow-y:auto">

      <!-- INFO DE LA SOLICITUD (vinculado) o CAMPOS LIBRES -->
      <div id="mr-info-solicitud" style="background:var(--gris);border-radius:10px;padding:12px;margin-bottom:16px;font-size:13px"></div>

      <!-- CAMPOS PARA REPORTE LIBRE -->
      <div id="mr-campos-libres" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
          <div class="modal-field" style="margin:0">
            <label>√Årea <span style="color:var(--error)">*</span></label>
            <select id="mr-area-libre">
              <option value="">Selecciona...</option>
              <option>Aire Acondicionado</option>
              <option>El√©ctrico</option>
              <option>Herrer√≠a</option>
              <option>Infraestructura</option>
              <option>Pintura</option>
              <option>Plomer√≠a</option>
              <option>Servicios Especializados</option>
              <option>Servicios Generales</option>
              <option>Otro</option>
            </select>
          </div>
          <div class="modal-field" style="margin:0">
            <label>Campus</label>
            <select id="mr-campus-libre">
              <option>Campus I</option>
              <option>Campus II</option>
              <option>Extensi√≥n Apaseo el Grande</option>
            </select>
          </div>
        </div>
        <div class="modal-field">
          <label>Ubicaci√≥n espec√≠fica <span style="color:var(--error)">*</span></label>
          <input type="text" id="mr-ubicacion-libre" placeholder="Ej: Ba√±os planta baja Edificio D">
        </div>
        <div class="modal-field">
          <label>Personal que realiza el trabajo</label>
          <div class="personal-grid" id="personal-grid-libre"></div>
        </div>
      </div>

      <!-- HISTORIAL DE AVANCES -->
      <div id="mr-historial-wrap" style="display:none">
        <div class="section-title">üìã Historial de avances</div>
        <div class="avances-lista" id="mr-historial"></div>
      </div>

      <!-- NUEVO AVANCE DEL D√çA -->
      <div class="section-title">‚úèÔ∏è Agregar avance del d√≠a</div>

      <div class="modal-field">
        <label>Fecha del reporte</label>
        <input type="date" id="mr-fecha">
      </div>
      <div class="modal-field">
        <label>Objetivo del trabajo</label>
        <textarea id="mr-objetivo" placeholder="¬øQu√© se busca lograr con este trabajo?" style="height:60px"></textarea>
      </div>
      <div class="modal-field">
        <label>Actividades realizadas hoy <span style="color:var(--error)">*</span></label>
        <textarea id="mr-actividades" placeholder="Describe lo que se hizo hoy..." style="height:80px"></textarea>
      </div>
      <div class="modal-field">
        <label>Notas o pendientes</label>
        <textarea id="mr-notas" placeholder="Pendientes para el siguiente d√≠a..." style="height:60px"></textarea>
      </div>
      <div class="modal-field">
        <label>Estatus del trabajo</label>
        <select id="mr-estatus">
          <option value="En proceso">üîß En proceso ‚Äî contin√∫a ma√±ana</option>
          <option value="Completado">‚úÖ Completado ‚Äî trabajo terminado</option>
          <option value="Pendiente / Detenido">‚è∏Ô∏è Detenido ‚Äî en espera de algo</option>
        </select>
      </div>

      <!-- FOTOS DE EVIDENCIA -->
      <div class="section-title">üì∑ Fotos de evidencia (m√°x. 12)</div>
      <div class="fotos-grid" id="mr-fotos-grid">
        <div class="foto-add" onclick="document.getElementById('mr-foto-input').click()">
          <span>üì∑</span>
          <span style="font-size:11px;margin-top:4px">Agregar foto</span>
        </div>
      </div>
      <input type="file" id="mr-foto-input" accept="image/*" multiple style="display:none" onchange="agregarFotos(event)">

    </div>
    <div class="modal-footer">
      <button class="btn-cancelar-modal" onclick="cerrarModalReporte()">Cancelar</button>
      <button class="btn-guardar" onclick="guardarReporte()">üíæ Guardar avance</button>
    </div>
  </div>
</div>

<!-- ===== MODAL VER FOTO ===== -->
<div id="modal-foto" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:300;align-items:center;justify-content:center" onclick="this.style.display='none'">
  <img id="modal-foto-img" style="max-width:95vw;max-height:95vh;border-radius:8px;object-fit:contain">
</div>

<!-- ===== MODAL ===== -->
<div class="modal-overlay" id="modal-overlay" onclick="cerrarModalOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-folio">Solicitud</h2>
      <button class="btn-cerrar" onclick="cerrarModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="info-grid" id="modal-info"></div>
      <div class="section-title">üìà Estado de la solicitud</div>
      <div id="modal-progreso" style="margin-bottom:16px"></div>
      <div class="section-title">üë∑ Asignar personal</div>
      <div class="personal-grid" id="personal-grid"></div>
      <div class="section-title">üìã Gesti√≥n de la solicitud</div>
      <div class="modal-field">
        <label>Estatus</label>
        <select id="m-estatus">
          <option value="Pendiente">‚è≥ Pendiente</option>
          <option value="En proceso">üîß En proceso</option>
          <option value="Completado">‚úÖ Completado</option>
          <option value="Cancelado">‚ùå Cancelado</option>
        </select>
      </div>
      <div class="modal-field">
        <div class="dos-col">
          <div><label>Fecha de inicio</label><input type="date" id="m-fecha-inicio"></div>
          <div><label>Fecha de cierre</label><input type="date" id="m-fecha-cierre"></div>
        </div>
      </div>
      <div class="modal-field">
        <label>Costo aproximado ($)</label>
        <input type="number" id="m-costo" placeholder="0.00" step="0.01">
      </div>
      <div class="modal-field">
        <label>Notas u observaciones</label>
        <textarea id="m-notas" placeholder="Notas internas del trabajo..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancelar-modal" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-guardar" onclick="guardarCambios()">üíæ Guardar cambios</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  const SUPABASE_URL = 'https://mtmylzxqlbwpcouogvac.supabase.co';
  const RESEND_KEY = 're_9jiWHEEa_FSoHeHysxkkPGo5bMXCkYqKA';

  // =============================================
  // NOTIFICACIONES POR CORREO
  // =============================================
  async function enviarNotificacionCorreo(solicitud) {
    if (!solicitud.contacto || solicitud.tipo_contacto !== 'correo') return;

    const html = `
      <div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto">
        <div style="background:#145e2e;padding:24px;border-radius:12px 12px 0 0;text-align:center">
          <h1 style="color:white;font-size:20px;margin:0">Instituto Tecnol√≥gico de Celaya</h1>
          <p style="color:rgba(255,255,255,0.8);margin:4px 0 0;font-size:13px">Departamento de Mantenimiento de Equipo</p>
        </div>
        <div style="background:white;padding:28px;border:1px solid #e0e0e0">
          <div style="background:#e8f5ee;border-radius:8px;padding:16px;text-align:center;margin-bottom:24px">
            <div style="font-size:40px">‚úÖ</div>
            <h2 style="color:#145e2e;margin:8px 0 4px;font-size:18px">¬°Tu solicitud fue completada!</h2>
            <div style="font-family:monospace;font-size:20px;font-weight:bold;color:#145e2e;letter-spacing:2px">${solicitud.folio}</div>
          </div>
          <table style="width:100%;border-collapse:collapse;font-size:14px">
            <tr style="border-bottom:1px solid #f0f0f0">
              <td style="padding:10px;color:#666;width:40%">√Årea atendida</td>
              <td style="padding:10px;font-weight:600">${solicitud.area}</td>
            </tr>
            <tr style="border-bottom:1px solid #f0f0f0">
              <td style="padding:10px;color:#666">Campus</td>
              <td style="padding:10px;font-weight:600">${solicitud.campus}</td>
            </tr>
            <tr style="border-bottom:1px solid #f0f0f0">
              <td style="padding:10px;color:#666">Ubicaci√≥n</td>
              <td style="padding:10px;font-weight:600">${solicitud.ubicacion}</td>
            </tr>
            <tr style="border-bottom:1px solid #f0f0f0">
              <td style="padding:10px;color:#666">Personal que atendi√≥</td>
              <td style="padding:10px;font-weight:600">${solicitud.personal_asignado || 'Equipo de mantenimiento'}</td>
            </tr>
            <tr>
              <td style="padding:10px;color:#666">Fecha de cierre</td>
              <td style="padding:10px;font-weight:600">${new Date().toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric'})}</td>
            </tr>
          </table>
          ${solicitud.notas_internas ? `<div style="background:#f9f9f9;border-radius:8px;padding:14px;margin-top:16px"><p style="margin:0;font-size:13px;color:#666"><b>Notas del trabajo:</b><br>${solicitud.notas_internas}</p></div>` : ''}
          <p style="font-size:13px;color:#888;margin-top:24px;text-align:center">Si tienes dudas sobre el trabajo realizado, ac√©rcate al Departamento de Mantenimiento de Equipo.</p>
        </div>
        <div style="background:#f5f5f5;padding:14px;border-radius:0 0 12px 12px;text-align:center">
          <p style="font-size:11px;color:#aaa;margin:0">Instituto Tecnol√≥gico de Celaya ‚Ä¢ Departamento de Mantenimiento de Equipo</p>
        </div>
      </div>`;

    try {
      await fetch('https://api.resend.com/emails', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${RESEND_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          from: 'Mantenimiento ITC <onboarding@resend.dev>',
          to: [solicitud.contacto],
          subject: `‚úÖ Tu solicitud ${solicitud.folio} fue completada`,
          html
        })
      });
      console.log('Correo enviado a:', solicitud.contacto);
    } catch(e) {
      console.error('Error enviando correo:', e);
    }
  }
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10bXlsenhxbGJ3cGNvdW9ndmFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTQxOTAsImV4cCI6MjA4NzAzMDE5MH0.u1EEguu4eUT8Uav2-kdCl358Aywp9jI9GcyFvpV-VfI';
  // Supabase nuevo formato - usar legacy tab para compatibilidad
  const SUPA_HEADERS = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json'
  };

  const USUARIOS = { 'admin': 'itc2026', 'jefe': 'mant2026', 'subdirector': 'sub2026' };

  const PERSONAL = [
    'CANCHE GARC√çA JOS√â LUIS','CASTRO REYES PEDRO EMMANUEL','CERRITOS JASSO DANIEL',
    'CERRITOS S√ÅNCHEZ SERGIO ARTURO','GUZM√ÅN MART√çNEZ EDUARDO','GUZM√ÅN MART√çNEZ JES√öS ALBERTO',
    'L√ìPEZ GOD√çNEZ JOS√â LAURO','MART√çNEZ JU√ÅREZ FRANCISCO','MART√çNEZ SALDA√ëA V√çCTOR MANUEL',
    'MOLINA G√ÅMEZ SERGIO','NIETO RAM√çREZ FERNANDO','NIETO RAM√çREZ FRANCISCO JAVIER',
    'ORTEGA DE LA MORA GUILLERMO','RAM√çREZ CANCHOLA PABLO','RAMOS VALLEJO EMANUEL'
  ];

  const COLORES_AREA = {
    'El√©ctrico':'#f39c12','Plomer√≠a':'#2980b9','Pintura':'#8e44ad',
    'Infraestructura':'#e67e22','Aire Acondicionado':'#16a085',
    'Herrer√≠a':'#7f8c8d','Servicios Generales':'#27ae60',
    'Servicios Especializados':'#c0392b','Otro':'#95a5a6'
  };

  let solicitudActual = null;
  let personalSeleccionado = [];
  let todosLosDatos = [];
  let diasFiltro = 30;
  let chartArea, chartEstatus, chartTiempo, chartCampus, chartCosto, chartGastoCampus;

  // ===== LOGIN =====
  function iniciarSesion() {
    const user = document.getElementById('login-user').value.trim().toLowerCase();
    const pass = document.getElementById('login-pass').value;
    if (USUARIOS[user] && USUARIOS[user] === pass) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('panel-principal').style.display = 'block';
      sessionStorage.setItem('itc-admin', user);
      cargarSolicitudes();
      cargarDatosDash();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  }

  function cerrarSesion() {
    sessionStorage.removeItem('itc-admin');
    document.getElementById('panel-principal').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('login-user').value = '';
    document.getElementById('login-pass').value = '';
  }

  window.onload = () => {
    if (sessionStorage.getItem('itc-admin')) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('panel-principal').style.display = 'block';
      cargarSolicitudes();
      cargarDatosDash();
    }
  };

  // ===== TABS =====
  function cambiarTab(tab, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    if (tab === 'dashboard') renderDashboard();
  }

  // ===== SOLICITUDES =====
  async function cargarSolicitudes() {
    const estatus = document.getElementById('filtro-estatus').value;
    const area = document.getElementById('filtro-area').value;
    const campus = document.getElementById('filtro-campus').value;
    let url = `${SUPABASE_URL}/rest/v1/solicitudes?select=*&order=fecha_creacion.desc`;
    if (estatus) url += `&estatus=eq.${encodeURIComponent(estatus)}`;
    if (area) url += `&area=eq.${encodeURIComponent(area)}`;
    if (campus) url += `&campus=eq.${encodeURIComponent(campus)}`;
    try {
      const res = await fetch(url, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
      const data = await res.json();
      renderTabla(data);
      actualizarStatsHeader(data);
    } catch(e) {
      console.error('Error al cargar solicitudes:', e);
      document.getElementById('tabla-body').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--sub)">Error al cargar. Intenta actualizar.</td></tr>';
    }
  }

  function actualizarStatsHeader(data) {
    fetch(`${SUPABASE_URL}/rest/v1/solicitudes?select=estatus`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    }).then(r => r.json()).then(all => {
      document.getElementById('stat-total').textContent = all.length;
      document.getElementById('stat-pendiente').textContent = all.filter(s => s.estatus === 'Pendiente').length;
      document.getElementById('stat-proceso').textContent = all.filter(s => s.estatus === 'En proceso').length;
      document.getElementById('stat-completado').textContent = all.filter(s => s.estatus === 'Completado').length;
    });
  }

  function renderTabla(data) {
    const tbody = document.getElementById('tabla-body');
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--sub)">No hay solicitudes con estos filtros.</td></tr>';
      return;
    }
    tbody.innerHTML = data.map((s, i) => `
      <tr onclick="abrirModal(${s.id})">
        <td style="text-align:center;font-weight:700;color:var(--sub);font-size:12px">${i+1}</td>
        <td><span class="folio-text">${s.folio||'‚Äî'}</span></td>
        <td>${formatFecha(s.fecha_creacion)}</td>
        <td>${s.area||'‚Äî'}</td>
        <td>${s.campus||'‚Äî'}</td>
        <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.ubicacion||'‚Äî'}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.descripcion||'‚Äî'}</td>
        <td>
          <span class="badge badge-${(s.estatus||'Pendiente').replace(' ','\ ')}">${s.estatus||'Pendiente'}</span>
          <div style="margin-top:4px">${miniProgreso(s.estatus, s.personal_asignado)}</div>
        </td>
        <td style="font-size:11px">${s.personal_asignado||'<span style="color:#aaa">Sin asignar</span>'}</td>
      </tr>`).join('');
  }

  // ===== BARRA DE PROGRESO =====
  function getProgresoInfo(estatus, personalAsignado) {
    // Pasos: Recibida(0) -> Asignada(1) -> En proceso(2) -> Completada(3)
    if (estatus === 'Cancelado') return { paso: -1, label: 'Cancelado' };
    if (estatus === 'Completado') return { paso: 3 };
    if (estatus === 'En proceso') return { paso: 2 };
    if (personalAsignado) return { paso: 1 };
    return { paso: 0 };
  }

  function miniProgreso(estatus, personalAsignado) {
    const { paso } = getProgresoInfo(estatus, personalAsignado);
    if (paso === -1) return '<div class="mini-progress">' + [0,1,2,3].map(i => '<div class="mini-dot cancelado"></div>').join('') + '</div>';
    return '<div class="mini-progress">' + [0,1,2,3].map(i => {
      const cls = i < paso ? 'done' : i === paso ? 'active' : '';
      return `<div class="mini-dot ${cls}"></div>`;
    }).join('') + '</div>';
  }

  function barraProgreso(estatus, personalAsignado) {
    const pasos = ['Recibida', 'Asignada', 'En proceso', 'Completada'];
    const { paso } = getProgresoInfo(estatus, personalAsignado);
    if (paso === -1) {
      return `<div style="text-align:center;padding:12px;background:#fdf2f2;border-radius:8px;color:var(--error);font-weight:700;font-size:13px">‚ùå Solicitud Cancelada</div>`;
    }
    let html = '<div class="progress-bar">';
    pasos.forEach((p, i) => {
      const done = i < paso;
      const active = i === paso;
      const cls = done ? 'done' : active ? 'active' : '';
      html += `<div class="progress-step ${cls}">
        <div class="progress-dot"></div>
        <span style="white-space:nowrap">${p}</span>
        ${i < pasos.length - 1 ? '<div class="progress-line"></div>' : ''}
      </div>`;
    });
    html += '</div>';
    const pct = Math.round((paso / 3) * 100);
    html += `<div style="margin-top:10px;background:#eee;border-radius:6px;height:8px;overflow:hidden">
      <div style="background:var(--verde);width:${pct}%;height:8px;border-radius:6px;transition:width 0.5s"></div>
    </div>
    <div style="text-align:right;font-size:11px;color:var(--sub);margin-top:4px;font-weight:600">${pct}% completado</div>`;
    return html;
  }

  function formatFecha(f) {
    if (!f) return '‚Äî';
    const d = new Date(f);
    return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
  }

  // ===== MODAL =====
  async function abrirModal(id) {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?id=eq.${id}&select=*`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const data = await res.json();
      if (!data || data.length === 0) return;
      solicitudActual = data[0];
      llenarModal(solicitudActual);
      document.getElementById('modal-overlay').classList.add('show');
    } catch(e) { toast('Error al cargar la solicitud.'); }
  }

  function llenarModal(s) {
    document.getElementById('modal-folio').textContent = s.folio || 'Solicitud';
    document.getElementById('modal-progreso').innerHTML = barraProgreso(s.estatus, s.personal_asignado);
    document.getElementById('modal-info').innerHTML = `
      <div class="info-item"><label>Solicitante</label><span>${s.nombre||'No especificado'}</span></div>
      <div class="info-item"><label>Contacto</label><span>${s.tipo_contacto==='whatsapp'?'üì±':'üìß'} ${s.contacto}</span></div>
      <div class="info-item"><label>Campus</label><span>${s.campus}</span></div>
      <div class="info-item"><label>√Årea</label><span>${s.area}</span></div>
      <div class="info-item full"><label>Ubicaci√≥n</label><span>${s.ubicacion}</span></div>
      <div class="info-item full"><label>Descripci√≥n</label><span>${s.descripcion}</span></div>
      <div class="info-item"><label>Fecha solicitud</label><span>${formatFecha(s.fecha_creacion)}</span></div>
      <div class="info-item"><label>Servicio</label><span>${s.servicio||s.area}</span></div>`;
    personalSeleccionado = s.personal_asignado ? s.personal_asignado.split(', ') : [];
    document.getElementById('personal-grid').innerHTML = PERSONAL.map(p => {
      const nombre = p.split(' ').slice(-2).join(' ');
      return `<div class="personal-chip ${personalSeleccionado.includes(p)?'selected':''}"
        onclick="togglePersonal(this,'${p}')" title="${p}">üë∑ ${nombre}</div>`;
    }).join('');
    document.getElementById('m-estatus').value = s.estatus || 'Pendiente';
    document.getElementById('m-fecha-inicio').value = s.fecha_inicio ? s.fecha_inicio.split('T')[0] : '';
    document.getElementById('m-fecha-cierre').value = s.fecha_cierre ? s.fecha_cierre.split('T')[0] : '';
    document.getElementById('m-costo').value = s.costo || '';
    document.getElementById('m-notas').value = s.notas_internas || '';
  }

  function togglePersonal(chip, nombre) {
    chip.classList.toggle('selected');
    if (chip.classList.contains('selected')) { if (!personalSeleccionado.includes(nombre)) personalSeleccionado.push(nombre); }
    else { personalSeleccionado = personalSeleccionado.filter(p => p !== nombre); }
  }

  function cerrarModal() { document.getElementById('modal-overlay').classList.remove('show'); solicitudActual = null; }
  function cerrarModalOverlay(e) { if (e.target === document.getElementById('modal-overlay')) cerrarModal(); }

  // =============================================
  // NOTIFICACIONES POR CORREO
  // =============================================
  async function enviarNotificacionCorreo(solicitud) {
    try {
      const html = `
        <div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;padding:20px">
          <div style="background:#145e2e;padding:20px;border-radius:12px 12px 0 0;text-align:center">
            <h1 style="color:white;font-size:20px;margin:0">Instituto Tecnol√≥gico de Celaya</h1>
            <p style="color:rgba(255,255,255,0.8);margin:6px 0 0;font-size:13px">Departamento de Mantenimiento de Equipo</p>
          </div>
          <div style="background:white;padding:28px;border:1px solid #e0e0e0;border-top:none">
            <div style="background:#e8f5ee;border-radius:10px;padding:16px;text-align:center;margin-bottom:24px">
              <div style="font-size:40px">‚úÖ</div>
              <h2 style="color:#145e2e;margin:8px 0 4px;font-size:18px">¬°Tu solicitud fue completada!</h2>
              <p style="color:#5a6b5e;margin:0;font-size:13px">El equipo de mantenimiento atendi√≥ tu reporte</p>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:14px">
              <tr><td style="padding:8px 12px;background:#f8f8f8;font-weight:bold;border-radius:6px 0 0 6px;width:40%">Folio</td>
                <td style="padding:8px 12px;background:#f8f8f8;border-radius:0 6px 6px 0"><b style="color:#145e2e">${solicitud.folio}</b></td></tr>
              <tr><td style="padding:8px 12px;font-weight:bold">√Årea atendida</td>
                <td style="padding:8px 12px">${solicitud.area}</td></tr>
              <tr><td style="padding:8px 12px;background:#f8f8f8;font-weight:bold;border-radius:6px 0 0 6px">Campus</td>
                <td style="padding:8px 12px;background:#f8f8f8;border-radius:0 6px 6px 0">${solicitud.campus}</td></tr>
              <tr><td style="padding:8px 12px;font-weight:bold">Ubicaci√≥n</td>
                <td style="padding:8px 12px">${solicitud.ubicacion}</td></tr>
              <tr><td style="padding:8px 12px;background:#f8f8f8;font-weight:bold;border-radius:6px 0 0 6px">Descripci√≥n</td>
                <td style="padding:8px 12px;background:#f8f8f8;border-radius:0 6px 6px 0">${solicitud.descripcion}</td></tr>
              ${solicitud.personal_asignado ? `<tr><td style="padding:8px 12px;font-weight:bold">Atendido por</td>
                <td style="padding:8px 12px">${solicitud.personal_asignado}</td></tr>` : ''}
            </table>
            <p style="font-size:12px;color:#999;margin-top:24px;text-align:center">
              Si tienes alguna duda puedes reportar un nuevo problema en el sistema de mantenimiento del ITC.<br>
              <b>Instituto Tecnol√≥gico de Celaya ‚Äî Departamento de Mantenimiento de Equipo</b>
            </p>
          </div>
        </div>`;

      const res = await fetch('https://api.resend.com/emails', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${RESEND_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          from: 'ITCelaya Mantenimiento <onboarding@resend.dev>',
          to: [solicitud.contacto],
          subject: 'Tu solicitud de mantenimiento fue completada ‚úÖ',
          html
        })
      });

      if (res.ok) {
        console.log('Correo enviado a', solicitud.contacto);
        return true;
      } else {
        const err = await res.text();
        console.error('Error correo:', err);
        return false;
      }
    } catch(e) {
      console.error('Error enviando correo:', e);
      return false;
    }
  }

  async function guardarCambios() {
    if (!solicitudActual) return;
    const estatus = document.getElementById('m-estatus').value;
    const fechaInicio = document.getElementById('m-fecha-inicio').value;
    const fechaCierre = document.getElementById('m-fecha-cierre').value;
    const costo = document.getElementById('m-costo').value;
    const notas = document.getElementById('m-notas').value;
    const datos = {
      estatus, personal_asignado: personalSeleccionado.join(', ') || null,
      fecha_inicio: fechaInicio || null, fecha_cierre: fechaCierre || null,
      costo: costo ? parseFloat(costo) : null, notas_internas: notas || null
    };
    if (estatus === 'En proceso' && !datos.fecha_inicio) datos.fecha_inicio = new Date().toISOString().split('T')[0];
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?id=eq.${solicitudActual.id}`, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify(datos)
      });
      if (res.ok) {
        if (estatus === 'Completado' && solicitudActual.tipo_contacto === 'correo' && solicitudActual.contacto) {
          const solActualizada = { ...solicitudActual, ...datos };
          const enviado = await enviarNotificacionCorreo(solActualizada);
          toast(enviado ? '‚úÖ Guardado ‚Äî Correo enviado a ' + solicitudActual.contacto + ' üìß' : '‚úÖ Guardado (correo no se pudo enviar)');
        } else if (estatus === 'Completado' && solicitudActual.tipo_contacto === 'whatsapp') {
          toast('‚úÖ Guardado ‚Äî Avisa al solicitante por WhatsApp al ' + solicitudActual.contacto + ' üì±');
        } else {
          toast('‚úÖ Cambios guardados correctamente');
        }
        cerrarModal(); cargarSolicitudes(); cargarDatosDash();
      }
      else { const err = await res.text(); toast('‚ùå Error: ' + err.substring(0,60)); }
    } catch(e) { toast('‚ùå Error de conexi√≥n.'); }
  }

  // ===== DASHBOARD =====
  async function cargarDatosDash() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?select=*&order=fecha_creacion.desc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      todosLosDatos = await res.json();
    } catch(e) { console.error(e); }
  }

  function filtrarPorPeriodo(datos, dias) {
    if (dias >= 9999) return datos;
    const limite = new Date();
    limite.setDate(limite.getDate() - dias);
    return datos.filter(s => new Date(s.fecha_creacion) >= limite);
  }

  function filtrarPeriodo(dias, btn) {
    diasFiltro = dias;
    document.querySelectorAll('.periodo-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderDashboard();
  }

  function renderDashboard() {
    const datos = filtrarPorPeriodo(todosLosDatos, diasFiltro);
    const total = datos.length;
    const pend = datos.filter(s => s.estatus === 'Pendiente').length;
    const proc = datos.filter(s => s.estatus === 'En proceso').length;
    const comp = datos.filter(s => s.estatus === 'Completado').length;
    document.getElementById('d-total').textContent = total;
    document.getElementById('d-pendiente').textContent = pend;
    document.getElementById('d-proceso').textContent = proc;
    document.getElementById('d-completado').textContent = comp;

    const conCosto = datos.filter(s => s.costo > 0);
    const totalCosto = conCosto.reduce((a,s) => a + parseFloat(s.costo||0), 0);
    const promCosto = conCosto.length ? totalCosto/conCosto.length : 0;
    const costoPorArea = {};
    datos.forEach(s => { if (s.costo>0) costoPorArea[s.area]=(costoPorArea[s.area]||0)+parseFloat(s.costo); });
    const maxArea = Object.entries(costoPorArea).sort((a,b)=>b[1]-a[1])[0];
    const completados = datos.filter(s => s.estatus==='Completado'&&s.fecha_inicio&&s.fecha_cierre);
    let tiempoProm = '‚Äî';
    if (completados.length > 0) {
      const td = completados.reduce((a,s)=>a+(new Date(s.fecha_cierre)-new Date(s.fecha_inicio))/(86400000),0);
      tiempoProm = Math.round(td/completados.length)+' d√≠as';
    }
    document.getElementById('d-costo-total').textContent = '$'+totalCosto.toLocaleString('es-MX',{minimumFractionDigits:0});
    document.getElementById('d-costo-prom').textContent = '$'+promCosto.toLocaleString('es-MX',{minimumFractionDigits:0});
    document.getElementById('d-area-max').textContent = maxArea ? maxArea[0] : '‚Äî';
    document.getElementById('d-tiempo-prom').textContent = tiempoProm;

    renderChartArea(datos); renderChartEstatus(datos); renderChartTiempo(datos);
    renderChartCampus(datos); renderChartCosto(datos); renderGastoCampus(datos); renderPersonal(datos);
  }

  function renderChartArea(datos) {
    const c = {}; datos.forEach(s => { c[s.area]=(c[s.area]||0)+1; });
    const labels = Object.keys(c).sort((a,b)=>c[b]-c[a]);
    if (chartArea) chartArea.destroy();
    chartArea = new Chart(document.getElementById('chart-area').getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ data: labels.map(l=>c[l]), backgroundColor: labels.map(l=>COLORES_AREA[l]||'#95a5a6'), borderRadius: 6, borderSkipped: false }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10}}},y:{grid:{color:'#f0f4f0'},ticks:{stepSize:1}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalle('Solicitudes ‚Äî '+labels[el[0].index], datos.filter(s=>s.area===labels[el[0].index])); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderChartEstatus(datos) {
    const c={'Pendiente':0,'En proceso':0,'Completado':0,'Cancelado':0};
    datos.forEach(s=>{if(c[s.estatus]!==undefined)c[s.estatus]++;});
    const labels=Object.keys(c).filter(k=>c[k]>0);
    const cols={'Pendiente':'#f39c12','En proceso':'#2980b9','Completado':'#1a7a3c','Cancelado':'#c0392b'};
    if(chartEstatus) chartEstatus.destroy();
    chartEstatus = new Chart(document.getElementById('chart-estatus').getContext('2d'),{
      type:'doughnut',
      data:{labels,datasets:[{data:labels.map(l=>c[l]),backgroundColor:labels.map(l=>cols[l]),borderWidth:3,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalle('Solicitudes ‚Äî '+labels[el[0].index],datos.filter(s=>s.estatus===labels[el[0].index])); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderChartTiempo(datos) {
    const c={}; datos.forEach(s=>{const f=s.fecha_creacion?s.fecha_creacion.split('T')[0]:null;if(f)c[f]=(c[f]||0)+1;});
    const fechas=Object.keys(c).sort();
    if(chartTiempo) chartTiempo.destroy();
    chartTiempo = new Chart(document.getElementById('chart-tiempo').getContext('2d'),{
      type:'line',
      data:{labels:fechas,datasets:[{label:'Solicitudes',data:fechas.map(f=>c[f]),borderColor:'#1a7a3c',backgroundColor:'rgba(26,122,60,0.1)',fill:true,tension:0.4,pointBackgroundColor:'#1a7a3c',pointRadius:5,pointHoverRadius:7}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10},maxTicksLimit:10}},y:{grid:{color:'#f0f4f0'},ticks:{stepSize:1}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalle('Solicitudes del '+fechas[el[0].index],datos.filter(s=>s.fecha_creacion&&s.fecha_creacion.startsWith(fechas[el[0].index]))); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderChartCampus(datos) {
    const c={}; datos.forEach(s=>{if(s.campus)c[s.campus]=(c[s.campus]||0)+1;});
    const labels=Object.keys(c);
    if(chartCampus) chartCampus.destroy();
    chartCampus = new Chart(document.getElementById('chart-campus').getContext('2d'),{
      type:'pie',
      data:{labels,datasets:[{data:labels.map(l=>c[l]),backgroundColor:['#145e2e','#2980b9','#e67e22'],borderWidth:3,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:10}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalle('Solicitudes ‚Äî '+labels[el[0].index],datos.filter(s=>s.campus===labels[el[0].index])); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderChartCosto(datos) {
    const c={}; datos.forEach(s=>{if(s.costo>0&&s.area)c[s.area]=(c[s.area]||0)+parseFloat(s.costo);});
    const labels=Object.keys(c).sort((a,b)=>c[b]-c[a]);
    if(chartCosto) chartCosto.destroy();
    chartCosto = new Chart(document.getElementById('chart-costo').getContext('2d'),{
      type:'bar',
      data:{labels,datasets:[{data:labels.map(l=>c[l]),backgroundColor:labels.map(l=>COLORES_AREA[l]||'#95a5a6'),borderRadius:6,borderSkipped:false}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>' $'+ctx.raw.toLocaleString('es-MX')}}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10}}},y:{grid:{color:'#f0f4f0'},ticks:{callback:v=>'$'+v.toLocaleString('es-MX')}}}
      }
    });
  }

  function renderGastoCampus(datos) {
    const c={}; datos.forEach(s=>{if(s.costo>0&&s.campus)c[s.campus]=(c[s.campus]||0)+parseFloat(s.costo);});
    const labels=Object.keys(c).sort((a,b)=>c[b]-c[a]);
    const total=Object.values(c).reduce((a,b)=>a+b,0);
    const colores=['#145e2e','#2980b9','#e67e22'];
    const detalle=document.getElementById('campus-gasto-detalle');
    if(labels.length===0){
      detalle.innerHTML='<div style="color:var(--sub);font-size:13px">Sin costos registrados a√∫n.</div>';
      if(chartGastoCampus){chartGastoCampus.destroy();chartGastoCampus=null;}
      return;
    }
    detalle.innerHTML=labels.map((campus,i)=>{
      const pct=total?Math.round(c[campus]/total*100):0;
      return `<div style="background:var(--gris);border-radius:10px;padding:14px;border-left:4px solid ${colores[i]||'#1a7a3c'}">
        <div style="font-size:11px;color:var(--sub);font-weight:600;margin-bottom:2px">${campus}</div>
        <div style="font-family:Montserrat,sans-serif;font-size:22px;font-weight:800;color:var(--texto)">$${c[campus].toLocaleString('es-MX',{minimumFractionDigits:0})}</div>
        <div style="font-size:11px;color:var(--sub);margin-top:4px">${pct}% del gasto total</div>
        <div style="margin-top:8px;background:#ddd;border-radius:4px;height:6px">
          <div style="background:${colores[i]||'#1a7a3c'};width:${pct}%;height:6px;border-radius:4px"></div>
        </div>
      </div>`;
    }).join('');
    if(chartGastoCampus) chartGastoCampus.destroy();
    chartGastoCampus = new Chart(document.getElementById('chart-gasto-campus').getContext('2d'),{
      type:'doughnut',
      data:{labels,datasets:[{data:labels.map(l=>c[l]),backgroundColor:colores.slice(0,labels.length),borderWidth:3,borderColor:'#fff'}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:10}},tooltip:{callbacks:{label:ctx=>` $${ctx.raw.toLocaleString('es-MX')} (${Math.round(ctx.raw/total*100)}%)`}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalle('Gasto ‚Äî '+labels[el[0].index],datos.filter(s=>s.campus===labels[el[0].index]&&s.costo>0)); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderPersonal(datos) {
    const c={};
    datos.forEach(s=>{if(s.personal_asignado)s.personal_asignado.split(', ').forEach(p=>{if(p.trim())c[p.trim()]=(c[p.trim()]||0)+1;});});
    const sorted=Object.entries(c).sort((a,b)=>b[1]-a[1]);
    const container=document.getElementById('personal-dash');
    if(sorted.length===0){container.innerHTML='<div style="color:var(--sub);font-size:13px;padding:10px">A√∫n no hay personal asignado.</div>';return;}
    container.innerHTML=sorted.map(([nombre,count])=>{
      const nombreCorto=nombre.split(' ').slice(-2).join(' ');
      return `<div class="personal-card"><div class="personal-count">${count}</div><div class="personal-nombre">${nombreCorto}</div><div class="personal-label">trabajo${count!==1?'s':''} asignado${count!==1?'s':''}</div></div>`;
    }).join('');
  }

  function mostrarDetalle(titulo, solicitudes) {
    document.getElementById('detalle-titulo').textContent = `${titulo} (${solicitudes.length})`;
    const tbody = document.getElementById('detalle-body');
    if(!solicitudes.length){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--sub)">Sin solicitudes</td></tr>';}
    else{tbody.innerHTML=solicitudes.map(s=>`
      <tr>
        <td style="font-weight:700;font-size:11px;color:var(--verde-oscuro)">${s.folio||'‚Äî'}</td>
        <td>${s.fecha_creacion?s.fecha_creacion.split('T')[0]:'‚Äî'}</td>
        <td>${s.area||'‚Äî'}</td>
        <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.ubicacion||'‚Äî'}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.descripcion||'‚Äî'}</td>
        <td style="font-size:11px">${s.personal_asignado||'<span style="color:#aaa">Sin asignar</span>'}</td>
        <td><span class="badge badge-${s.estatus}">${s.estatus||'Pendiente'}</span></td>
        <td>${s.costo?'$'+parseFloat(s.costo).toLocaleString('es-MX'):'‚Äî'}</td>
      </tr>`).join('');}
    const panel=document.getElementById('detalle-panel');
    panel.classList.add('show');
    panel.scrollIntoView({behavior:'smooth',block:'start'});
  }

  function cerrarDetalle() { document.getElementById('detalle-panel').classList.remove('show'); }

  function toast(msg) {
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.opacity='1';
    clearTimeout(window._tt);
    window._tt=setTimeout(()=>t.style.opacity='0',3000);
  }

  // =============================================
  // DASHBOARD DE REPORTES
  // =============================================
  let todosLosReportes = [];
  let diasFiltroRep = 30;
  let rcArea, rcEstatus, rcTiempo, rcCampus, rcTipo;

  async function cargarDatosReportes() {
    try {
      // Cargar tanto reportes de la tabla reportes como solicitudes con folio L
      const [resRep, resSol] = await Promise.all([
        fetch(`${SUPABASE_URL}/rest/v1/reportes?select=*&order=fecha.desc`, {
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        }),
        fetch(`${SUPABASE_URL}/rest/v1/solicitudes?select=*&order=fecha_creacion.desc`, {
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        })
      ]);
      const reportes = await resRep.json();
      const solicitudes = await resSol.json();

      // Normalizar solicitudes como reportes
      const solComoRep = solicitudes.map(s => ({
        folio: s.folio,
        fecha: s.fecha_creacion ? s.fecha_creacion.split('T')[0] : null,
        area: s.area,
        ubicacion: s.ubicacion,
        objetivo: s.descripcion,
        actividades: s.notas_internas || '',
        estatus: s.estatus,
        personal: s.personal_asignado,
        campus: s.campus,
        tipo: s.folio && s.folio.includes('/L') ? 'libre' : 'solicitud'
      }));

      // Normalizar reportes de tabla reportes
      const repNorm = (Array.isArray(reportes) ? reportes : []).map(r => ({
        folio: r.folio_libre || `REP-${r.id}`,
        fecha: r.fecha,
        area: r.area,
        ubicacion: r.ubicacion,
        objetivo: r.objetivo,
        actividades: r.actividades,
        estatus: r.estatus,
        personal: r.personal,
        campus: null,
        tipo: r.folio_libre ? 'libre' : 'solicitud'
      }));

      todosLosReportes = [...solComoRep, ...repNorm];
    } catch(e) {
      console.error('Error cargando reportes:', e);
      todosLosReportes = [];
    }
  }

  function filtrarPorPeriodoRep(datos, dias) {
    if (dias >= 9999) return datos;
    const limite = new Date();
    limite.setDate(limite.getDate() - dias);
    return datos.filter(r => r.fecha && new Date(r.fecha) >= limite);
  }

  function filtrarPeriodoRep(dias, btn) {
    diasFiltroRep = dias;
    document.querySelectorAll('#tab-dash-reportes .periodo-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderDashReportes();
  }

  function renderDashReportes() {
    const datos = filtrarPorPeriodoRep(todosLosReportes, diasFiltroRep);
    const total = datos.length;
    const comp = datos.filter(r => r.estatus === 'Completado').length;
    const proc = datos.filter(r => r.estatus === 'En proceso').length;
    const det = datos.filter(r => r.estatus === 'Pendiente / Detenido' || r.estatus === 'Pendiente').length;

    document.getElementById('dr-total').textContent = total;
    document.getElementById('dr-completado').textContent = comp;
    document.getElementById('dr-proceso').textContent = proc;
    document.getElementById('dr-detenido').textContent = det;

    renderRcArea(datos); renderRcEstatus(datos); renderRcTiempo(datos);
    renderRcCampus(datos); renderRcTipo(datos); renderPersonalRep(datos);
  }

  function renderRcArea(datos) {
    const c = {}; datos.forEach(r => { if(r.area) c[r.area]=(c[r.area]||0)+1; });
    const labels = Object.keys(c).sort((a,b)=>c[b]-c[a]);
    if(rcArea) rcArea.destroy();
    rcArea = new Chart(document.getElementById('rc-area').getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ data: labels.map(l=>c[l]), backgroundColor: labels.map(l=>COLORES_AREA[l]||'#95a5a6'), borderRadius:6, borderSkipped:false }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10}}},y:{grid:{color:'#f0f4f0'},ticks:{stepSize:1}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalleRep('Reportes ‚Äî '+labels[el[0].index], datos.filter(r=>r.area===labels[el[0].index])); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderRcEstatus(datos) {
    const c={'Completado':0,'En proceso':0,'Pendiente / Detenido':0,'Pendiente':0};
    datos.forEach(r=>{ if(c[r.estatus]!==undefined) c[r.estatus]++; else c['Pendiente']++; });
    const merged = {'Completado':c['Completado'],'En proceso':c['En proceso'],'Detenido/Pendiente':c['Pendiente / Detenido']+c['Pendiente']};
    const labels = Object.keys(merged).filter(k=>merged[k]>0);
    const cols = {'Completado':'#1a7a3c','En proceso':'#2980b9','Detenido/Pendiente':'#f39c12'};
    if(rcEstatus) rcEstatus.destroy();
    rcEstatus = new Chart(document.getElementById('rc-estatus').getContext('2d'), {
      type:'doughnut',
      data:{labels, datasets:[{data:labels.map(l=>merged[l]), backgroundColor:labels.map(l=>cols[l]), borderWidth:3, borderColor:'#fff'}]},
      options:{responsive:true, maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}}}}
    });
  }

  function renderRcTiempo(datos) {
    const c={}; datos.forEach(r=>{if(r.fecha)c[r.fecha]=(c[r.fecha]||0)+1;});
    const fechas=Object.keys(c).sort();
    if(rcTiempo) rcTiempo.destroy();
    rcTiempo = new Chart(document.getElementById('rc-tiempo').getContext('2d'), {
      type:'line',
      data:{labels:fechas, datasets:[{label:'Reportes', data:fechas.map(f=>c[f]),
        borderColor:'#2980b9', backgroundColor:'rgba(41,128,185,0.1)', fill:true,
        tension:0.4, pointBackgroundColor:'#2980b9', pointRadius:5, pointHoverRadius:7}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10},maxTicksLimit:10}},y:{grid:{color:'#f0f4f0'},ticks:{stepSize:1}}},
        onClick:(e,el)=>{ if(el.length) mostrarDetalleRep('Reportes del '+fechas[el[0].index], datos.filter(r=>r.fecha===fechas[el[0].index])); },
        onHover:(e,el)=>{e.native.target.style.cursor=el.length?'pointer':'default';}
      }
    });
  }

  function renderRcCampus(datos) {
    const c={}; datos.forEach(r=>{if(r.campus)c[r.campus]=(c[r.campus]||0)+1;});
    const labels=Object.keys(c);
    if(!labels.length) return;
    if(rcCampus) rcCampus.destroy();
    rcCampus = new Chart(document.getElementById('rc-campus').getContext('2d'), {
      type:'pie',
      data:{labels, datasets:[{data:labels.map(l=>c[l]), backgroundColor:['#145e2e','#2980b9','#e67e22'], borderWidth:3, borderColor:'#fff'}]},
      options:{responsive:true, maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:10}}}}
    });
  }

  function renderRcTipo(datos) {
    const libre = datos.filter(r=>r.tipo==='libre').length;
    const solicitud = datos.filter(r=>r.tipo==='solicitud').length;
    if(rcTipo) rcTipo.destroy();
    rcTipo = new Chart(document.getElementById('rc-tipo').getContext('2d'), {
      type:'doughnut',
      data:{
        labels:['üîß Libre (DME/L...)', 'üìã Por solicitud'],
        datasets:[{data:[libre, solicitud], backgroundColor:['#2980b9','#1a7a3c'], borderWidth:3, borderColor:'#fff'}]
      },
      options:{responsive:true, maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:12}},
          tooltip:{callbacks:{label:ctx=>` ${ctx.raw} reportes (${Math.round(ctx.raw/(libre+solicitud)*100)}%)`}}}
      }
    });
  }

  function renderPersonalRep(datos) {
    const c={};
    datos.forEach(r=>{if(r.personal)r.personal.split(', ').forEach(p=>{if(p.trim())c[p.trim()]=(c[p.trim()]||0)+1;});});
    const sorted=Object.entries(c).sort((a,b)=>b[1]-a[1]);
    const container=document.getElementById('personal-rep-dash');
    if(!sorted.length){container.innerHTML='<div style="color:var(--sub);font-size:13px;padding:10px">Sin datos de personal a√∫n.</div>';return;}
    container.innerHTML=sorted.map(([nombre,count])=>{
      const nombreCorto=nombre.split(' ').slice(-2).join(' ');
      return `<div class="personal-card"><div class="personal-count">${count}</div><div class="personal-nombre">${nombreCorto}</div><div class="personal-label">reporte${count!==1?'s':''} realizado${count!==1?'s':''}</div></div>`;
    }).join('');
  }

  function mostrarDetalleRep(titulo, reportes) {
    document.getElementById('detalle-rep-titulo').textContent = `${titulo} (${reportes.length})`;
    const tbody = document.getElementById('detalle-rep-body');
    tbody.innerHTML = reportes.map(r=>`
      <tr>
        <td style="font-weight:700;font-size:11px;color:var(--verde-oscuro)">${r.folio||'‚Äî'}</td>
        <td>${r.fecha||'‚Äî'}</td>
        <td>${r.area||'‚Äî'}</td>
        <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.ubicacion||'‚Äî'}</td>
        <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.objetivo||'‚Äî'}</td>
        <td style="font-size:11px">${r.personal||'<span style="color:#aaa">‚Äî</span>'}</td>
        <td><span class="badge badge-${r.estatus}">${r.estatus||'‚Äî'}</span></td>
      </tr>`).join('');
    const panel=document.getElementById('detalle-rep-panel');
    panel.classList.add('show');
    panel.scrollIntoView({behavior:'smooth',block:'start'});
  }

  function cerrarDetalleRep() { document.getElementById('detalle-rep-panel').classList.remove('show'); }

  setInterval(()=>{ cargarSolicitudes(); cargarDatosDash(); }, 60000);

  // =============================================
  // REPORTES DIARIOS
  // =============================================
  let reporteSolicitudActual = null;
  let esReporteLibre = false;
  let personalLibreSeleccionado = [];
  let fotosReporte = [];
  let reportesExistentes = [];

  const PREFIJOS_AREA = {
    'El√©ctrico':'LElec','Plomer√≠a':'LPlom','Pintura':'LPint',
    'Infraestructura':'LIAca','Aire Acondicionado':'LAAco',
    'Herrer√≠a':'LHerr','Servicios Generales':'LSGen',
    'Servicios Especializados':'LSEsp','Otro':'LOtro'
  };

  async function generarFolioLibre(area) {
    const prefijo = PREFIJOS_AREA[area] || 'LOtro';
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?folio=like.DME/${prefijo}/*&select=folio&order=folio.desc&limit=1`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const data = await res.json();
      let siguiente = 1;
      if (data && data.length > 0) {
        const ultimo = data[0].folio.split('/')[2];
        siguiente = parseInt(ultimo) + 1;
      }
      return `DME/${prefijo}/${String(siguiente).padStart(5,'0')}`;
    } catch(e) {
      return `DME/${prefijo}/${Date.now().toString().slice(-5)}`;
    }
  }

  function abrirReporteLibre() {
    esReporteLibre = true;
    reporteSolicitudActual = null;
    fotosReporte = [];
    personalLibreSeleccionado = [];

    document.getElementById('mr-folio').textContent = 'üîß Nuevo Reporte Libre';
    document.getElementById('mr-solicitud-info').textContent = 'Trabajo de mantenimiento sin solicitud previa';
    document.getElementById('mr-info-solicitud').innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;color:var(--verde-oscuro)">
        <span style="font-size:24px">üîß</span>
        <div>
          <div style="font-weight:700;font-family:Montserrat,sans-serif;font-size:13px">Reporte de trabajo libre</div>
          <div style="font-size:12px;color:var(--sub)">El folio se generar√° autom√°ticamente con prefijo L (libre)</div>
        </div>
      </div>`;

    // Mostrar campos libres, ocultar historial
    document.getElementById('mr-campos-libres').style.display = 'block';
    document.getElementById('mr-historial-wrap').style.display = 'none';

    // Llenar chips de personal en reporte libre
    document.getElementById('personal-grid-libre').innerHTML = PERSONAL.map(p => {
      const nombre = p.split(' ').slice(-2).join(' ');
      return `<div class="personal-chip" onclick="togglePersonalLibre(this,'${p}')" title="${p}">üë∑ ${nombre}</div>`;
    }).join('');

    // Valores por defecto
    document.getElementById('mr-fecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('mr-objetivo').value = '';
    document.getElementById('mr-actividades').value = '';
    document.getElementById('mr-notas').value = '';
    document.getElementById('mr-estatus').value = 'Completado';
    document.getElementById('mr-area-libre').value = '';
    renderFotosGrid();

    document.getElementById('modal-reporte-overlay').classList.add('show');
  }

  function togglePersonalLibre(chip, nombre) {
    chip.classList.toggle('selected');
    if (chip.classList.contains('selected')) {
      if (!personalLibreSeleccionado.includes(nombre)) personalLibreSeleccionado.push(nombre);
    } else {
      personalLibreSeleccionado = personalLibreSeleccionado.filter(p => p !== nombre);
    }
  }

  const ICONOS_AREA = {
    'El√©ctrico':'‚ö°','Plomer√≠a':'üîß','Pintura':'üé®','Infraestructura':'üèóÔ∏è',
    'Aire Acondicionado':'‚ùÑÔ∏è','Herrer√≠a':'‚öôÔ∏è','Servicios Generales':'üè¢',
    'Servicios Especializados':'üî¨','Otro':'‚ùì'
  };

  function diasSinAtender(fechaCreacion) {
    const hoy = new Date();
    const creacion = new Date(fechaCreacion);
    return Math.floor((hoy - creacion) / (1000*60*60*24));
  }

  function getCardClass(solicitud) {
    if (solicitud.estatus === 'Completado') return 'completado';
    if (solicitud.estatus === 'En proceso') return 'en-proceso';
    if (diasSinAtender(solicitud.fecha_creacion) > 4) return 'urgente';
    return 'pendiente';
  }

  function getIconoEstatus(solicitud) {
    if (solicitud.estatus === 'Completado') return '‚úÖ';
    if (solicitud.estatus === 'En proceso') return 'ü¶∫';
    if (diasSinAtender(solicitud.fecha_creacion) > 4) return 'üö®';
    return 'üîî';
  }

  async function cargarReportes() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?select=*&order=fecha_creacion.desc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const solicitudes = await res.json();
      renderReportes(solicitudes);
    } catch(e) {
      document.getElementById('reportes-lista').innerHTML = '<div style="text-align:center;padding:40px;color:var(--sub)">Error al cargar reportes.</div>';
    }
  }

  function renderReportes(solicitudes) {
    if (!solicitudes || solicitudes.length === 0) {
      document.getElementById('reportes-lista').innerHTML = '<div style="text-align:center;padding:60px;color:var(--sub)"><div style="font-size:48px;margin-bottom:12px">üì≠</div><p>No hay solicitudes a√∫n.</p></div>';
      return;
    }

    // Agrupar por d√≠a
    const grupos = {};
    solicitudes.forEach((s, i) => {
      const num = i + 1;
      const fecha = s.fecha_creacion ? s.fecha_creacion.split('T')[0] : 'Sin fecha';
      if (!grupos[fecha]) grupos[fecha] = [];
      grupos[fecha].push(s);
    });

    const fechas = Object.keys(grupos).sort((a,b) => b.localeCompare(a));
    let html = '';

    fechas.forEach(fecha => {
      const d = new Date(fecha + 'T12:00:00');
      const fechaLabel = d.toLocaleDateString('es-MX', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      html += `<div class="dia-grupo">
        <div class="dia-header">üìÖ ${fechaLabel.charAt(0).toUpperCase() + fechaLabel.slice(1)}</div>`;

      grupos[fecha].forEach(s => {
        const cardClass = getCardClass(s);
        const icono = getIconoEstatus(s);
        const iconoArea = ICONOS_AREA[s.area] || 'üîß';
        const dias = diasSinAtender(s.fecha_creacion);
        const alertaDias = (s.estatus !== 'Completado' && dias > 4) ? `<span style="font-size:10px;color:var(--error);font-weight:700">‚ö†Ô∏è ${dias} d√≠as sin atender</span>` : '';

        html += `<div class="reporte-card ${cardClass}" onclick="abrirModalReporte(${s.id})">
          <div class="reporte-thumb-placeholder">${iconoArea}</div>
          <div class="reporte-info">
            <div class="reporte-fecha">${formatFecha(s.fecha_creacion)} ‚Ä¢ ${s.folio || 'Sin folio'}</div>
            <div class="reporte-area">${s.area || 'Sin √°rea'}</div>
            <div class="reporte-ubicacion">${s.ubicacion || ''}</div>
            ${alertaDias}
          </div>
          <div class="reporte-estatus-col">
            <span class="icono-estatus">${icono}</span>
            <span class="badge badge-${s.estatus}">${s.estatus || 'Pendiente'}</span>
          </div>
        </div>`;
      });

      html += '</div>';
    });

    document.getElementById('reportes-lista').innerHTML = html;
  }

  async function abrirModalReporte(solicitudId) {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?id=eq.${solicitudId}&select=*`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const data = await res.json();
      if (!data || data.length === 0) return;
      reporteSolicitudActual = data[0];
      fotosReporte = [];

      // Cargar reportes existentes de esta solicitud
      // Buscar reportes por folio_libre
      const folioSolicitud = data[0].folio;
      console.log('Buscando reportes para folio:', folioSolicitud);
      const resRep2 = await fetch(`${SUPABASE_URL}/rest/v1/reportes?folio_libre=eq.${folioSolicitud}&select=*&order=fecha.desc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const rep2 = await resRep2.json();
      console.log('Reportes encontrados:', rep2);
      // Tambi√©n buscar por solicitud_id
      const resRep1 = await fetch(`${SUPABASE_URL}/rest/v1/reportes?solicitud_id=eq.${solicitudId}&select=*&order=fecha.desc`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const rep1 = await resRep1.json();
      reportesExistentes = [...(Array.isArray(rep1)?rep1:[]), ...(Array.isArray(rep2)?rep2:[])];
      reportesExistentes.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
      console.log('Total reportes existentes:', reportesExistentes.length);

      llenarModalReporte(reporteSolicitudActual, reportesExistentes);
      document.getElementById('modal-reporte-overlay').classList.add('show');
    } catch(e) { toast('Error al abrir reporte.'); }
  }

  function llenarModalReporte(s, reportes) {
    document.getElementById('mr-campos-libres').style.display = 'none';
    document.getElementById('mr-folio').textContent = s.folio || 'Reporte de Trabajo';
    document.getElementById('mr-solicitud-info').textContent = `${s.area} ‚Ä¢ ${s.campus} ‚Ä¢ ${s.ubicacion}`;

    document.getElementById('mr-info-solicitud').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><span style="font-size:10px;color:var(--sub);font-weight:700;font-family:Montserrat,sans-serif">√ÅREA</span><br><b>${s.area}</b></div>
        <div><span style="font-size:10px;color:var(--sub);font-weight:700;font-family:Montserrat,sans-serif">CAMPUS</span><br><b>${s.campus}</b></div>
        <div style="grid-column:1/-1"><span style="font-size:10px;color:var(--sub);font-weight:700;font-family:Montserrat,sans-serif">UBICACI√ìN</span><br><b>${s.ubicacion}</b></div>
        <div style="grid-column:1/-1"><span style="font-size:10px;color:var(--sub);font-weight:700;font-family:Montserrat,sans-serif">PROBLEMA REPORTADO</span><br>${s.descripcion}</div>
        <div><span style="font-size:10px;color:var(--sub);font-weight:700;font-family:Montserrat,sans-serif">PERSONAL ASIGNADO</span><br>${s.personal_asignado || 'Sin asignar'}</div>
        <div><span style="font-size:10px;color:var(--sub);font-weight:700;font-family:Montserrat,sans-serif">INICIO</span><br>${s.fecha_inicio ? s.fecha_inicio.toString().substring(0,10) : 'No definida'}</div>
      </div>`;

    // Historial de avances
    const historialWrap = document.getElementById('mr-historial-wrap');
    if (reportes && reportes.length > 0) {
      historialWrap.style.display = 'block';
      const histHtml = reportes.map(r => {
          const obj = r.objetivo || '';
          const act = r.actividades || '';
          const not = r.notas || '';
          const pers = r.personal || '';
          let html = '<div class="avance-item">';
          html += '<div class="avance-fecha">' + formatFecha(r.fecha) + ' ‚Äî <span class="badge badge-' + r.estatus + '">' + r.estatus + '</span>';
          if (pers) html += ' <span style="font-size:11px;color:var(--sub)">‚Ä¢ ' + pers + '</span>';
          html += '</div>';
          if (obj) html += '<div style="font-size:12px;color:#2980b9;margin-top:6px;padding:6px 8px;background:#f0f6ff;border-radius:6px"><b>üéØ Objetivo:</b> ' + obj + '</div>';
          if (act) html += '<div style="font-size:13px;color:#2c3e50;margin-top:6px"><b>üîß Actividades:</b><br>' + act.replace(/\n/g,'<br>') + '</div>';
          if (not) html += '<div style="font-size:12px;color:#7f8c8d;margin-top:6px;padding:6px 8px;background:#fffbf0;border-radius:6px"><b>üìù Notas:</b> ' + not + '</div>';
          if (r.fotos && r.fotos.length > 0) {
            html += '<div class="avance-fotos">';
            r.fotos.forEach(function(f){ html += '<img src="' + f + '" class="avance-foto-thumb" onclick="verFoto(\'' + f + '\')" onerror="this.style.display=\'none\'">'; });
            html += '</div>';
          }
          html += '</div>';
          return html;
        }).join('');
        document.getElementById('mr-historial').innerHTML = histHtml;
    } else {
      historialWrap.style.display = 'none';
    }

    // Valores por defecto
    document.getElementById('mr-fecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('mr-objetivo').value = '';
    document.getElementById('mr-actividades').value = '';
    document.getElementById('mr-notas').value = '';
    document.getElementById('mr-estatus').value = s.estatus === 'Completado' ? 'Completado' : 'En proceso';
    renderFotosGrid();
  }

  function agregarFotos(e) {
    const nuevas = Array.from(e.target.files);
    nuevas.forEach(f => { if (fotosReporte.length < 12) fotosReporte.push(f); });
    renderFotosGrid();
    e.target.value = '';
  }

  function renderFotosGrid() {
    const grid = document.getElementById('mr-fotos-grid');
    let html = fotosReporte.map((f, i) => {
      const url = URL.createObjectURL(f);
      return `<div class="foto-item">
        <img src="${url}" onclick="verFoto('${url}')">
        <button class="foto-remove" onclick="quitarFoto(${i})">‚úï</button>
      </div>`;
    }).join('');
    if (fotosReporte.length < 12) {
      html += `<div class="foto-add" onclick="document.getElementById('mr-foto-input').click()">
        <span>üì∑</span><span style="font-size:11px;margin-top:4px">Agregar</span>
      </div>`;
    }
    grid.innerHTML = html;
  }

  function quitarFoto(i) { fotosReporte.splice(i, 1); renderFotosGrid(); }

  function verFoto(url) {
    document.getElementById('modal-foto-img').src = url;
    document.getElementById('modal-foto').style.display = 'flex';
  }

  async function guardarReporte() {
    const actividades = document.getElementById('mr-actividades').value.trim();
    if (!actividades) { toast('‚ö†Ô∏è Escribe las actividades realizadas.'); return; }

    // Validar campos de reporte libre
    if (esReporteLibre) {
      const area = document.getElementById('mr-area-libre').value;
      const ubicacion = document.getElementById('mr-ubicacion-libre').value.trim();
      if (!area) { toast('‚ö†Ô∏è Selecciona el √°rea del trabajo.'); return; }
      if (!ubicacion) { toast('‚ö†Ô∏è Escribe la ubicaci√≥n del trabajo.'); return; }
    } else if (!reporteSolicitudActual) return;

    const btn = document.querySelector('#modal-reporte-overlay .btn-guardar');
    btn.disabled = true;
    btn.textContent = 'Guardando...';

    try {
      // Subir fotos
      const urlsFotos = [];
      for (let i = 0; i < fotosReporte.length; i++) {
        const file = fotosReporte[i];
        const ext = file.name.split('.').pop();
        const path = `reportes/${reporteSolicitudActual.folio}/dia_${Date.now()}_${i}.${ext}`;
        const resF = await fetch(`${SUPABASE_URL}/storage/v1/object/Solicitudes-fotos/${path}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': file.type, 'x-upsert': 'true' },
          body: file
        });
        if (resF.ok) urlsFotos.push(`${SUPABASE_URL}/storage/v1/object/public/Solicitudes-fotos/${path}`);
      }

      // Determinar datos seg√∫n tipo de reporte
      let areaReporte, ubicacionReporte, solicitudId, personalReporte, folioReporte;

      if (esReporteLibre) {
        areaReporte = document.getElementById('mr-area-libre').value;
        ubicacionReporte = document.getElementById('mr-ubicacion-libre').value.trim();
        solicitudId = null;
        personalReporte = personalLibreSeleccionado.join(', ') || null;
        folioReporte = await generarFolioLibre(areaReporte);
      } else {
        areaReporte = reporteSolicitudActual.area;
        ubicacionReporte = reporteSolicitudActual.ubicacion;
        solicitudId = reporteSolicitudActual.id;
        personalReporte = reporteSolicitudActual.personal_asignado || null;
        folioReporte = reporteSolicitudActual.folio;
      }

      // Guardar reporte
      const nuevoReporte = {
        solicitud_id: solicitudId,
        folio_libre: esReporteLibre ? folioReporte : null,
        fecha: document.getElementById('mr-fecha').value,
        area: areaReporte,
        ubicacion: ubicacionReporte,
        objetivo: document.getElementById('mr-objetivo').value.trim() || null,
        actividades,
        notas: document.getElementById('mr-notas').value.trim() || null,
        estatus: document.getElementById('mr-estatus').value,
        personal: personalReporte,
        fotos: urlsFotos
      };

      const resR = await fetch(`${SUPABASE_URL}/rest/v1/reportes`, {
        method: 'POST',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify(nuevoReporte)
      });

      if (!resR.ok) throw new Error(await resR.text());

      // Solo actualizar solicitud si es reporte vinculado
      if (!esReporteLibre && reporteSolicitudActual) {
        const nuevoEstatus = document.getElementById('mr-estatus').value === 'Completado' ? 'Completado' : 'En proceso';
        await fetch(`${SUPABASE_URL}/rest/v1/solicitudes?id=eq.${reporteSolicitudActual.id}`, {
          method: 'PATCH',
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
          body: JSON.stringify({ estatus: nuevoEstatus, fecha_cierre: nuevoEstatus === 'Completado' ? new Date().toISOString().split('T')[0] : null })
        });
      }

      toast(esReporteLibre ? '‚úÖ Reporte libre guardado ‚Äî ' + folioReporte : '‚úÖ Avance guardado correctamente');
      cerrarModalReporte();
      cargarReportes();
      cargarSolicitudes();

    } catch(e) {
      console.error(e);
      toast('‚ùå Error al guardar. Intenta de nuevo.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'üíæ Guardar avance';
    }
  }

  function cerrarModalReporte() {
    document.getElementById('modal-reporte-overlay').classList.remove('show');
    reporteSolicitudActual = null;
    esReporteLibre = false;
    personalLibreSeleccionado = [];
    fotosReporte = [];
    document.getElementById('mr-campos-libres').style.display = 'none';
    document.getElementById('mr-area-libre').value = '';
    document.getElementById('mr-ubicacion-libre').value = '';
  }

  function cerrarModalReporteOverlay(e) {
    if (e.target === document.getElementById('modal-reporte-overlay')) cerrarModalReporte();
  }

  // Cargar reportes cuando se cambia a esa pesta√±a
  const _cambiarTabOriginal = cambiarTab;
  function cambiarTab(tab, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    if (tab === 'dashboard') renderDashboard();
    if (tab === 'reportes') cargarReportes();
    if (tab === 'dash-reportes') { cargarDatosReportes().then(()=>renderDashReportes()); }
  }

</script>
</body>
</html>
